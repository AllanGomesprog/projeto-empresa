<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Atendimento - Padula Contabilidade</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<style>
    :root {
        --primary-container: #3A5A99;
        --on-primary-container: #FFFFFF;
        --primary-fixed: #DDE2FF;
        --on-primary-fixed: #213B70;
        --surface: #F8F9FA;
        --surface-container: #FFFFFF;
        --on-surface: #1A202C;
        --outline: #CBD5E0;
        --text-muted: #64748B;
        --success: #10B981;
        --warning: #F59E0B;
        --error: #EF4444;

        --font-family: 'Roboto', sans-serif;
        --border-radius-large: 16px;
        --border-radius-medium: 8px;
        --border-radius-small: 4px;
        --shadow-1: 0 1px 3px rgba(0,0,0,0.1);
        --shadow-2: 0 4px 6px rgba(0,0,0,0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: var(--font-family);
        background-color: var(--surface);
        color: var(--on-surface);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--outline);
    }

    .admin-header h1 {
        color: var(--primary-container);
        font-size: 2rem;
    }

    .admin-actions {
        display: flex;
        gap: 10px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 20px;
        font-weight: 500;
        font-size: 0.9rem;
        border-radius: var(--border-radius-medium);
        text-decoration: none;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        cursor: pointer;
        white-space: nowrap;
    }

    .btn-primary {
        background-color: var(--primary-container);
        color: var(--on-primary-container);
    }

    .btn-secondary {
        background-color: var(--surface-container);
        color: var(--on-surface);
        border-color: var(--outline);
    }

    .btn-success {
        background-color: var(--success);
        color: white;
    }

    .btn-warning {
        background-color: var(--warning);
        color: white;
    }

    .btn-error {
        background-color: var(--error);
        color: white;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-muted);
    }

    select, input {
        padding: 8px 12px;
        border: 1px solid var(--outline);
        border-radius: var(--border-radius-small);
        font-family: inherit;
        background-color: var(--surface-container);
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background-color: var(--surface-container);
        padding: 20px;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-1);
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .contacts-table {
        background-color: var(--surface-container);
        border-radius: var(--border-radius-medium);
        overflow: hidden;
        box-shadow: var(--shadow-1);
    }

    .table-header {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
        padding: 15px 20px;
        background-color: var(--primary-container);
        color: var(--on-primary-container);
        font-weight: 500;
    }

    .table-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
        padding: 15px 20px;
        border-bottom: 1px solid var(--outline);
        align-items: center;
    }

    .table-row:last-child {
        border-bottom: none;
    }

    .table-row:hover {
        background-color: #f5f5f5;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .status-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .status-contacted {
        background-color: #D1FAE5;
        color: #065F46;
    }

    .status-resolved {
        background-color: #DBEAFE;
        color: #1E40AF;
    }

    .no-contacts {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--surface-container);
        border-radius: var(--border-radius-medium);
        padding: 30px;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--outline);
        border-radius: var(--border-radius-small);
        font-family: inherit;
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    @media (max-width: 768px) {
        .table-header, .table-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .table-header {
            display: none;
        }
        
        .table-row {
            border: 1px solid var(--outline);
            border-radius: var(--border-radius-medium);
            margin-bottom: 10px;
            padding: 15px;
        }
        
        .mobile-label {
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .filters {
            flex-direction: column;
        }
        
        .admin-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        .admin-actions {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
<body>
    <div class="container">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> Painel Atendimento</h1>
            <div class="admin-actions">
                <button class="btn btn-secondary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-primary" id="addContactBtn">
                    <i class="fas fa-plus"></i> Adicionar Contato
                </button>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar ao Site
                </a>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="departmentFilter">Setor</label>
                <select id="departmentFilter">
                    <option value="all">Todos os Setores</option>
                    <option value="fiscal">Fiscal</option>
                    <option value="contabilidade">Contabilidade</option>
                    <option value="pessoal">Departamento Pessoal</option>
                    <option value="societario">Societ√°rio</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status</label>
                <select id="statusFilter">
                    <option value="all">Todos os Status</option>
                    <option value="pending">Pendente</option>
                    <option value="contacted">Contactado</option>
                    <option value="resolved">Resolvido</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Data</label>
                <input type="date" id="dateFilter">
            </div>
            <div class="filter-group">
                <label for="searchFilter">Buscar</label>
                <input type="text" id="searchFilter" placeholder="Nome, e-mail ou telefone">
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" id="totalContacts">0</div>
                <div class="stat-label">Total de Contatos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingContacts">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="contactedContacts">0</div>
                <div class="stat-label">Contactados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolvedContacts">0</div>
                <div class="stat-label">Resolvidos</div>
            </div>
        </div>

        <div class="contacts-table">
            <div class="table-header">
                <div>Nome</div>
                <div>E-mail</div>
                <div>Telefone</div>
                <div>Setor</div>
                <div>Data</div>
                <div>A√ß√µes</div>
            </div>
            <div id="contactsList">
                <!-- Contatos ser√£o carregados aqui -->
            </div>
        </div>

        <!-- Modal para adicionar/editar contato -->
        <div class="modal" id="contactModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Adicionar Contato</h2>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
                <form id="contactForm">
                    <input type="hidden" id="contactId">
                    <div class="form-group">
                        <label for="contactName">Nome</label>
                        <input type="text" id="contactName" required>
                    </div>
                    <div class="form-group">
                        <label for="contactEmail">E-mail</label>
                        <input type="email" id="contactEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="contactPhone">Telefone</label>
                        <input type="tel" id="contactPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="contactDepartment">Setor</label>
                        <select id="contactDepartment" required>
                            <option value="fiscal">Fiscal</option>
                            <option value="contabilidade">Contabilidade</option>
                            <option value="pessoal">Departamento Pessoal</option>
                            <option value="societario">Societ√°rio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contactStatus">Status</label>
                        <select id="contactStatus" required>
                            <option value="pending">Pendente</option>
                            <option value="contacted">Contactado</option>
                            <option value="resolved">Resolvido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contactNotes">Observa√ß√µes</label>
                        <textarea id="contactNotes"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // =========================
        // Configura√ß√£o do Firebase
        // =========================
        const firebaseConfig = {
  apiKey: "AIzaSyDlnpekdefRb6v7VWD1cieFHsx0dmDQu-k",
  authDomain: "padula-contabilidade.firebaseapp.com",
  databaseURL: "https://padula-contabilidade-default-rtdb.firebaseio.com",
  projectId: "padula-contabilidade",
  storageBucket: "padula-contabilidade.firebasestorage.app",
  messagingSenderId: "840272874573",
  appId: "1:840272874573:web:bcd5297c6e92dbd7526004",
  measurementId: "G-NZ4WCXFRBZ"
};

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Verificar se √© administrador
        if (localStorage.getItem('isAdmin') !== 'true' && !window.location.search.includes('admin=true')) {
            alert('Acesso n√£o autorizado. Redirecionando para a p√°gina principal.');
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da interface
            const contactsList = document.getElementById('contactsList');
            const totalContacts = document.getElementById('totalContacts');
            const pendingContacts = document.getElementById('pendingContacts');
            const contactedContacts = document.getElementById('contactedContacts');
            const resolvedContacts = document.getElementById('resolvedContacts');
            const refreshBtn = document.getElementById('refreshBtn');
            const addContactBtn = document.getElementById('addContactBtn');
            const contactModal = document.getElementById('contactModal');
            const modalClose = document.getElementById('modalClose');
            const cancelBtn = document.getElementById('cancelBtn');
            const contactForm = document.getElementById('contactForm');
            const modalTitle = document.getElementById('modalTitle');
            const contactId = document.getElementById('contactId');
            
            // Filtros
            const departmentFilter = document.getElementById('departmentFilter');
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
            const searchFilter = document.getElementById('searchFilter');

            let contacts = [];
            let unsubscribe;

            // Fun√ß√£o para formatar n√∫mero de telefone para WhatsApp
            function formatPhoneForWhatsApp(phone) {
                // Remove tudo que n√£o √© n√∫mero
                let cleanPhone = phone.replace(/\D/g, '');
                
                // Remove o 0 inicial se houver (para n√∫meros com DDD)
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = cleanPhone.substring(1);
                }
                
                // Adiciona c√≥digo do Brasil se n√£o tiver
                if (!cleanPhone.startsWith('55')) {
                    cleanPhone = '55' + cleanPhone;
                }
                
                return cleanPhone;
            }

            // Carregar contatos
            function loadContacts() {
                if (unsubscribe) unsubscribe(); // Cancela a escuta anterior

                unsubscribe = db.collection('contacts')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        contacts = [];
                        snapshot.forEach(doc => {
                            contacts.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        updateContactsList();
                        updateStats();
                    }, error => {
                        console.error('Erro ao carregar contatos:', error);
                    });
            }

           // Atualizar lista de contatos
function updateContactsList() {
    let filteredContacts = [...contacts];
    
    // Aplicar filtros
    if (departmentFilter.value !== 'all') {
        filteredContacts = filteredContacts.filter(contact => 
            contact.department === departmentFilter.value
        );
    }
    
    if (statusFilter.value !== 'all') {
        filteredContacts = filteredContacts.filter(contact => 
            contact.status === statusFilter.value
        );
    }
    
    // CORRE√á√ÉO: Filtro por data
    if (dateFilter.value) {
        const filterDate = new Date(dateFilter.value);
        filteredContacts = filteredContacts.filter(contact => {
            if (!contact.timestamp) return false;
            
            const contactDate = contact.timestamp.toDate();
            // Remove horas, minutos, segundos e milissegundos para comparar apenas a data
            const contactDateOnly = new Date(contactDate.getFullYear(), contactDate.getMonth(), contactDate.getDate());
            const filterDateOnly = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate());
            
            return contactDateOnly.getTime() === filterDateOnly.getTime();
        });
    }
    
    if (searchFilter.value) {
        const searchTerm = searchFilter.value.toLowerCase();
        filteredContacts = filteredContacts.filter(contact => 
            contact.name.toLowerCase().includes(searchTerm) ||
            contact.email.toLowerCase().includes(searchTerm) ||
            contact.phone.includes(searchTerm)
        );
    }

    // Atualizar a interface
    if (filteredContacts.length === 0) {
        contactsList.innerHTML = '<div class="no-contacts">Nenhum contato encontrado</div>';
        return;
    }

    contactsList.innerHTML = '';
    filteredContacts.forEach(contact => {
        const contactDate = contact.timestamp ? 
            contact.timestamp.toDate().toLocaleString('pt-BR') : 
            'Data n√£o dispon√≠vel';
        
        const statusClass = `status-${contact.status}`;
        const statusText = {
            'pending': 'Pendente',
            'contacted': 'Contactado',
            'resolved': 'Resolvido'
        }[contact.status] || contact.status;
        
        const departmentText = {
            'fiscal': 'Fiscal',
            'contabilidade': 'Contabilidade',
            'pessoal': 'Dep. Pessoal',
            'societario': 'Societ√°rio'
        }[contact.department] || contact.department;

        const row = document.createElement('div');
        row.className = 'table-row';
        row.innerHTML = `
            <div>
                <span class="mobile-label">Nome:</span>
                ${contact.name}
            </div>
            <div>
                <span class="mobile-label">E-mail:</span>
                ${contact.email}
            </div>
            <div>
                <span class="mobile-label">Telefone:</span>
                ${contact.phone}
            </div>
            <div>
                <span class="mobile-label">Setor:</span>
                ${departmentText}
            </div>
            <div>
                <span class="mobile-label">Data:</span>
                ${contactDate}
            </div>
            <div>
                <span class="mobile-label">A√ß√µes:</span>
                <span class="status-badge ${statusClass}">${statusText}</span>
                <button class="btn btn-success btn-small contact-btn" data-id="${contact.id}">
    <i class="fab fa-whatsapp"></i>
</button>
<button class="btn btn-warning btn-small resolve-btn" data-id="${contact.id}">
    <i class="fas fa-check"></i>
</button>
<button class="btn btn-primary btn-small edit-btn" data-id="${contact.id}">
    <i class="fas fa-edit"></i>
</button>
<button class="btn btn-error btn-small delete-btn" data-id="${contact.id}">
    <i class="fas fa-trash"></i>
</button>
            </div>
        `;
        
        contactsList.appendChild(row);
    });

    // Adicionar event listeners aos bot√µes
    document.querySelectorAll('.contact-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const contactId = e.target.closest('button').dataset.id;
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                // CORRE√á√ÉO: Formatar o n√∫mero corretamente para o WhatsApp
                const formattedPhone = formatPhoneForWhatsApp(contact.phone);
                const message = `Ol√° ${contact.name}! Em que posso ajud√°-lo(a)?`;
                
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Atualizar status para "contacted"
                db.collection('contacts').doc(contactId).update({
                    status: 'contacted'
                });
            }
        });
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const contactId = e.target.closest('button').dataset.id;
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                openEditModal(contact);
            }
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const contactId = e.target.closest('button').dataset.id;
            if (confirm('Tem certeza que deseja excluir este contato?')) {
                db.collection('contacts').doc(contactId).delete();
            }
        });
    });
    // Adicionar event listener para o bot√£o de resolver
document.querySelectorAll('.resolve-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const contactId = e.target.closest('button').dataset.id;
        if (confirm('Marcar este contato como resolvido?')) {
            db.collection('contacts').doc(contactId).update({
                status: 'resolved',
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    });
});
}
           
            function updateStats() {
                totalContacts.textContent = contacts.length;
                pendingContacts.textContent = contacts.filter(c => c.status === 'pending').length;
                contactedContacts.textContent = contacts.filter(c => c.status === 'contacted').length;
                resolvedContacts.textContent = contacts.filter(c => c.status === 'resolved').length;
            }

            // Abrir modal para editar contato
            function openEditModal(contact = null) {
                if (contact) {
                    modalTitle.textContent = 'Editar Contato';
                    contactId.value = contact.id;
                    document.getElementById('contactName').value = contact.name;
                    document.getElementById('contactEmail').value = contact.email;
                    document.getElementById('contactPhone').value = contact.phone;
                    document.getElementById('contactDepartment').value = contact.department;
                    document.getElementById('contactStatus').value = contact.status;
                    document.getElementById('contactNotes').value = contact.notes || '';
                } else {
                    modalTitle.textContent = 'Adicionar Contato';
                    contactForm.reset();
                    contactId.value = '';
                }
                contactModal.style.display = 'flex';
            }

            // Fechar modal
            function closeModal() {
                contactModal.style.display = 'none';
            }

            // Event listeners
            refreshBtn.addEventListener('click', loadContacts);
            addContactBtn.addEventListener('click', () => openEditModal());
            modalClose.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            contactForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const contactData = {
                    name: document.getElementById('contactName').value,
                    email: document.getElementById('contactEmail').value,
                    phone: document.getElementById('contactPhone').value,
                    department: document.getElementById('contactDepartment').value,
                    status: document.getElementById('contactStatus').value,
                    notes: document.getElementById('contactNotes').value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (contactId.value) {
                    // Atualizar contato existente
                    db.collection('contacts').doc(contactId.value).update(contactData)
                        .then(() => {
                            closeModal();
                        })
                        .catch(error => {
                            console.error('Erro ao atualizar contato:', error);
                            alert('Erro ao atualizar contato. Tente novamente.');
                        });
                } else {
                    // Adicionar novo contato
                    db.collection('contacts').add(contactData)
                        .then(() => {
                            closeModal();
                        })
                        .catch(error => {
                            console.error('Erro ao adicionar contato:', error);
                            alert('Erro ao adicionar contato. Tente novamente.');
                        });
                }
            });

            // Filtros
            departmentFilter.addEventListener('change', updateContactsList);
            statusFilter.addEventListener('change', updateContactsList);
            dateFilter.addEventListener('change', updateContactsList);
            searchFilter.addEventListener('input', updateContactsList);

            // Inicializar
            loadContacts();
        });
    </script>
</body>
</html>
